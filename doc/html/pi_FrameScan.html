
<!DOCTYPE html
  PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
   <!--
This HTML was auto-generated from MATLAB code.
To make changes, update the MATLAB code and republish this document.
      --><title>FrameScan</title><meta name="generator" content="MATLAB 9.0"><link rel="schema.DC" href="http://purl.org/dc/elements/1.1/"><meta name="DC.date" content="2017-09-01"><meta name="DC.source" content="pi_FrameScan.m"><style type="text/css">
html,body,div,span,applet,object,iframe,h1,h2,h3,h4,h5,h6,p,blockquote,pre,a,abbr,acronym,address,big,cite,code,del,dfn,em,font,img,ins,kbd,q,s,samp,small,strike,strong,sub,sup,tt,var,b,u,i,center,dl,dt,dd,ol,ul,li,fieldset,form,label,legend,table,caption,tbody,tfoot,thead,tr,th,td{margin:0;padding:0;border:0;outline:0;font-size:100%;vertical-align:baseline;background:transparent}body{line-height:1}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:before,blockquote:after,q:before,q:after{content:'';content:none}:focus{outine:0}ins{text-decoration:none}del{text-decoration:line-through}table{border-collapse:collapse;border-spacing:0}

html { min-height:100%; margin-bottom:1px; }
html body { height:100%; margin:0px; font-family:Arial, Helvetica, sans-serif; font-size:10px; color:#000; line-height:140%; background:#fff none; overflow-y:scroll; }
html body td { vertical-align:top; text-align:left; }

h1 { padding:0px; margin:0px 0px 25px; font-family:Arial, Helvetica, sans-serif; font-size:1.5em; color:#d55000; line-height:100%; font-weight:normal; }
h2 { padding:0px; margin:0px 0px 8px; font-family:Arial, Helvetica, sans-serif; font-size:1.2em; color:#000; font-weight:bold; line-height:140%; border-bottom:1px solid #d6d4d4; display:block; }
h3 { padding:0px; margin:0px 0px 5px; font-family:Arial, Helvetica, sans-serif; font-size:1.1em; color:#000; font-weight:bold; line-height:140%; }

a { color:#005fce; text-decoration:none; }
a:hover { color:#005fce; text-decoration:underline; }
a:visited { color:#004aa0; text-decoration:none; }

p { padding:0px; margin:0px 0px 20px; }
img { padding:0px; margin:0px 0px 20px; border:none; }
p img, pre img, tt img, li img, h1 img, h2 img { margin-bottom:0px; } 

ul { padding:0px; margin:0px 0px 20px 23px; list-style:square; }
ul li { padding:0px; margin:0px 0px 7px 0px; }
ul li ul { padding:5px 0px 0px; margin:0px 0px 7px 23px; }
ul li ol li { list-style:decimal; }
ol { padding:0px; margin:0px 0px 20px 0px; list-style:decimal; }
ol li { padding:0px; margin:0px 0px 7px 23px; list-style-type:decimal; }
ol li ol { padding:5px 0px 0px; margin:0px 0px 7px 0px; }
ol li ol li { list-style-type:lower-alpha; }
ol li ul { padding-top:7px; }
ol li ul li { list-style:square; }

.content { font-size:1.2em; line-height:140%; padding: 20px; }

pre, code { font-size:12px; }
tt { font-size: 1.2em; }
pre { margin:0px 0px 20px; }
pre.codeinput { padding:10px; border:1px solid #d3d3d3; background:#f7f7f7; }
pre.codeoutput { padding:10px 11px; margin:0px 0px 20px; color:#4c4c4c; }
pre.error { color:red; }

@media print { pre.codeinput, pre.codeoutput { word-wrap:break-word; width:100%; } }

span.keyword { color:#0000FF }
span.comment { color:#228B22 }
span.string { color:#A020F0 }
span.untermstring { color:#B20000 }
span.syscmd { color:#B28C00 }

.footer { width:auto; padding:10px 0px; margin:25px 0px 0px; border-top:1px dotted #878787; font-size:0.8em; line-height:140%; font-style:italic; color:#878787; text-align:left; float:none; }
.footer p { margin:0px; }
.footer a { color:#878787; }
.footer a:hover { color:#878787; text-decoration:underline; }
.footer a:visited { color:#878787; }

table th { padding:7px 5px; text-align:left; vertical-align:middle; border: 1px solid #d6d4d4; font-weight:bold; }
table td { padding:7px 5px; text-align:left; vertical-align:top; border:1px solid #d6d4d4; }





  </style></head><body><div class="content"><h1>FrameScan</h1><!--introduction--><p>Analyse frame scan images of vessels</p><!--/introduction--><h2>Contents</h2><div><ul><li><a href="#1">Usage</a></li><li><a href="#2">Arguments</a></li><li><a href="#3">Details</a></li><li><a href="#4">See Also</a></li><li><a href="#5">Examples</a></li></ul></div><h2>Usage<a name="1"></a></h2><pre class="language-matlab">OBJ = FrameScan(NAME, RAWIMG, CONFIG, ISDS, COLS_V, ROWS_V, COLS_D)
</pre><h2>Arguments<a name="2"></a></h2><div><ul><li><tt>NAME</tt> is the name for this <tt>FrameScan</tt> object.</li><li><tt>RAWIMG</tt> is the <tt>RawImg</tt> object that will be used to create the <tt>FrameScan</tt> object.</li><li><tt>CONFIG</tt> contains the configuration parameters needed for the <tt>calcVelocity</tt> and <tt>calcDiameter</tt> object.</li><li><tt>ISDS</tt> specifies whether the streaks to analyse are dark (i.e. negatively labelled) or bright (i.e. positively labelled).</li><li><tt>COLS_V</tt> specifies the left and right columns that will form the edges of the <tt>RawImg</tt> data to use in the velocity calculation.</li><li><tt>ROWS_V</tt> specifies the top and bottom rows that will form the edges of the <tt>RawImg</tt> data to use in the velocity calculation.</li><li><tt>COLS_D</tt> specifies the left and right columns that will form the edges of the <tt>RawImg</tt> data to use in the diameter calculation.</li></ul></div><h2>Details<a name="3"></a></h2><p><tt>FrameScan</tt> objects are used to analyse both the velocities and diameters from frame scan images of blood vessels.  Typically, the blood plasma will be labelled by a fluorescent marker, like a dextran conjugated fluorophore (e.g. FITC, as in the figure below), but the method also works with labelled red blood cells (RBCs).</p><p><img vspace="5" hspace="5" src="fs_example_rawImg.png" alt=""> </p><h2>See Also<a name="4"></a></h2><div><ul><li><a href="matlab:doc('FrameScan')"><tt>FrameScan</tt> class documentation</a></li><li><a href="matlab:doc('ConfigFrameScan')"><tt>ConfigFrameScan</tt> class documentation</a></li><li><a href="matlab:doc('ConfigVelocityRadon')"><tt>ConfigVelocityRadon</tt> class documentation</a></li><li><a href="matlab:doc('ConfigVelocityLSPIV')"><tt>ConfigVelocityLSPIV</tt> class documentation</a></li><li><a href="matlab:doc('ConfigDiameterFWHM')"><tt>ConfigDiameterFWHM</tt> class documentation</a></li><li><a href="matlab:doc('CalcVelocityRadon')"><tt>CalcVelocityRadon</tt> class documentation</a></li><li><a href="matlab:doc('CalcVelocityLSPIV')"><tt>CalcVelocityLSPIV</tt> class documentation</a></li><li><a href="matlab:doc('CalcDiameterFWHM')"><tt>CalcDiameterFWHM</tt> class documentation</a></li><li><a href="matlab:doc('ImgGroup')"><tt>ImgGroup</tt> class documentation</a></li><li><a href="ig_ImgGroup.html"><tt>ImgGroup</tt> quick start guide</a></li></ul></div><h2>Examples<a name="5"></a></h2><p>The following examples require the sample images and other files, which can be downloaded manually, from the University of Zurich website (<a href="http://www.pharma.uzh.ch/en/research/functionalimaging/CHIPS.html">http://www.pharma.uzh.ch/en/research/functionalimaging/CHIPS.html</a>), or automatically, by running the function <tt>utils.download_example_imgs()</tt>.</p><p><h3>Create a <tt>FrameScan</tt> object interactively</h3></p><p>The following example will illustrate the process of creating a <tt>FrameScan</tt> object interactively, starting with calling the constructor.</p><pre class="language-matlab"><span class="comment">% Call the FrameScan constructor</span>
fs01 = FrameScan()
</pre><p>Since no RawImg has been specified, the first stage is to select the type of RawImg to create.  Press three and then enter to select the SCIM_Tif.</p><pre>----- What type of RawImg would you like to load? -----</pre><pre>  &gt;&gt; 1) BioFormats
     2) RawImgDummy
     3) SCIM_Tif</pre><pre>Select a format: 3</pre><p>A warning may appear about the pixel aspect ratio, but this is not relevant for <tt>FrameScan</tt> images.</p><p>Then, use the interactive dialogue box to select the raw image file <tt>framescan_scim.tif</tt>, which should be located in the subfolder tests&gt;res, within the CHIPS root directory.</p><p><img vspace="5" hspace="5" src="fs_sel_rawImg.png" alt=""> </p><p>Use the interactive dialogue box to select the dummy calibration (<tt>calibration_dummy.mat</tt>):</p><p><img vspace="5" hspace="5" src="sel_cal.png" alt=""> </p><p>The next stage is to define the 'meaning' of the image channels.  The first channel represents the blood plasma. Press one and then enter to complete the selection.</p><pre>----- What is shown on channel 1? -----</pre><pre>  &gt;&gt; 0) &lt;blank&gt;
     1) blood_plasma
     2) blood_rbcs</pre><pre>Answer: 1</pre><p>The next stage is to specify which velocity calculation algorithm should be used. In this case we will choose the Radon transform method.  Press two and then enter to complete the selection.</p><pre>----- What type of velocity calculation would you like to use? -----</pre><pre>  &gt;&gt; 1) CalcVelocityLSPIV
     2) CalcVelocityRadon</pre><pre>Select a format: 2</pre><p>The next stage is to select the limits of the image to use for velocity calculations.  Selecting left and right limits can be useful to exclude the edges where there can be artefacts associated with the scan mirrors changing speed and/or direction.  Selecting top and bottom limits ensures that the velocity is only calculated inside the vessel.</p><p><img vspace="5" hspace="5" src="fs_sel_edges_lr_v.png" alt=""> </p><p><img vspace="5" hspace="5" src="fs_sel_edges_tb_v.png" alt=""> </p><p>The final stage is to select the left and right limits of the image to use for diameter calculations.  This can be useful to exclude the edges where there can be artefacts associated with other vessels or fluorescent areas.</p><p><img vspace="5" hspace="5" src="fs_sel_edges_lr_d.png" alt=""> </p><p>We have now created a <tt>FrameScan</tt> object interactively.</p><pre>fs01 =</pre><pre>  FrameScan with properties:</pre><pre>    calcDiameter: [1x1 CalcDiameterFWHM]
   colsToUseDiam: [21 110]
    rowsToUseVel: [27 94]
        plotList: [1x1 struct]
    calcVelocity: [1x1 CalcVelocityRadon]
    colsToUseVel: [20 112]
   isDarkStreaks: 1
           state: 'unprocessed'
            name: 'framescan_scim'
          rawImg: [1x1 SCIM_Tif]
    isDarkPlasma: 0</pre><p>The process is almost exactly the same to create an array of <tt>FrameScan</tt> objects; when the software prompts you to select one or more raw images, simply select multiple images by using either the shift or control key.</p><p><h3>Prepare a <tt>RawImg</tt> for use in these examples</h3></p><pre class="codeinput"><span class="comment">% Prepare a rawImg for use in these examples</span>
fnRawImg = fullfile(utils.CHIPS_rootdir, <span class="string">'tests'</span>, <span class="string">'res'</span>, <span class="keyword">...</span>
    <span class="string">'framescan_scim.tif'</span>);
channels = struct(<span class="string">'blood_plasma'</span>, 1);
fnCalibration = fullfile(utils.CHIPS_rootdir, <span class="string">'tests'</span>, <span class="string">'res'</span>, <span class="keyword">...</span>
    <span class="string">'calibration_dummy.mat'</span>);
calibration = CalibrationPixelSize.load(fnCalibration);
rawImg = SCIM_Tif(fnRawImg, channels, calibration);
</pre><pre class="codeoutput">Opening framescan_scim.tif: 100% [=================================]
</pre><p><h3>Create a <tt>FrameScan</tt> object without any interaction</h3></p><pre class="codeinput"><span class="comment">% Create a FrameScan object without any interaction</span>
nameFS02 = <span class="string">'test FS 02'</span>;
configFS = ConfigFrameScan(ConfigVelocityLSPIV(), ConfigDiameterFWHM);
isDarkStreaks = [];
colsToUseVel = [20 112];
rowsToUseVel = [27 94];
colsToUseDiam = [21 110];
fs02 = FrameScan(nameFS02, rawImg, configFS, isDarkStreaks, <span class="keyword">...</span>
    colsToUseVel, rowsToUseVel, colsToUseDiam)
</pre><pre class="codeoutput">
fs02 = 

  FrameScan with properties:

     calcDiameter: [1x1 CalcDiameterFWHM]
    colsToUseDiam: [21 110]
     rowsToUseVel: [27 94]
         plotList: [1x1 struct]
     calcVelocity: [1x1 CalcVelocityLSPIV]
     colsToUseVel: [20 112]
    isDarkStreaks: 1
            state: 'unprocessed'
             name: 'test FS 02'
           rawImg: [1x1 SCIM_Tif]
     isDarkPlasma: 0

</pre><p><h3>Create a <tt>FrameScan</tt> object with a custom config</h3></p><pre class="codeinput"><span class="comment">% Create a FrameScan object with a custom config</span>
configCustom = ConfigFrameScan(<span class="keyword">...</span>
    ConfigVelocityRadon(<span class="string">'windowTime'</span>, 30, <span class="string">'nOverlap'</span>, 6), <span class="keyword">...</span>
    ConfigDiameterFWHM(<span class="string">'maxRate'</span>, 10, <span class="string">'lev50'</span>, 0.6));
fs03 = FrameScan(<span class="string">'test FS 03'</span>, rawImg, configCustom, <span class="keyword">...</span>
    isDarkStreaks, colsToUseVel, rowsToUseVel, colsToUseDiam);
confDiam = fs03.calcDiameter.config
confVel = fs03.calcVelocity.config
</pre><pre class="codeoutput">
confDiam = 

  ConfigDiameterFWHM with properties:

           lev50: 0.6000
         maxRate: 10
    thresholdSTD: 3


confVel = 

  ConfigVelocityRadon with properties:

       windowTime: 30
         nOverlap: 6
         thetaMax: 90
         thetaMin: -90
       incrCoarse: 1
         incrFine: 0.1000
      rangeCoarse: 10
        rangeFine: 3
        tolCoarse: 8
       maxNCoarse: 2
         maxNFull: 1
      minPeakDist: 5
    thresholdProm: 0.3000
        pointsSNR: 12
     thresholdSNR: 3
     thresholdSTD: 3

</pre><p><h3>Create a <tt>FrameScan</tt> object array</h3></p><pre class="codeinput"><span class="comment">% Create the RawImg array first</span>
rawImgArray(1:3) = copy(rawImg);
rawImgArray = copy(rawImgArray)
</pre><pre class="codeoutput">
rawImgArray = 

  1x3 SCIM_Tif array with properties:

    filename
    isDenoised
    isMotionCorrected
    metadata_original
    name
    rawdata
    t0
    metadata

</pre><pre class="codeinput"><span class="comment">% Then create the FrameScan object array</span>
fsArray = FrameScan(<span class="string">'test FS Array'</span>, rawImgArray, configCustom, <span class="keyword">...</span>
    isDarkStreaks, colsToUseVel, rowsToUseVel, colsToUseDiam)
</pre><pre class="codeoutput">
fsArray = 

  1x3 FrameScan array with properties:

    calcDiameter
    colsToUseDiam
    rowsToUseVel
    plotList
    calcVelocity
    colsToUseVel
    isDarkStreaks
    state
    name
    rawImg
    isDarkPlasma

</pre><p><h3>Process a scalar <tt>FrameScan</tt> object</h3></p><pre class="codeinput"><span class="comment">% Process a scalar FrameScan object</span>
fs03 = fs03.process()
</pre><pre class="codeoutput">Calculating velocity: 100% [=======================================]
Calculating diameter: 100% [=======================================]

fs03 = 

  FrameScan with properties:

     calcDiameter: [1x1 CalcDiameterFWHM]
    colsToUseDiam: [21 110]
     rowsToUseVel: [27 94]
         plotList: [1x1 struct]
     calcVelocity: [1x1 CalcVelocityRadon]
     colsToUseVel: [20 112]
    isDarkStreaks: 1
            state: 'processed'
             name: 'test FS 03'
           rawImg: [1x1 SCIM_Tif]
     isDarkPlasma: 0

</pre><p><h3>Process a <tt>FrameScan</tt> object array (in parallel)</h3></p><pre class="codeinput"><span class="comment">% Process a FrameScan object array (in parallel).</span>
<span class="comment">% This code requires the Parallel Computing Toolbox to run in parallel</span>
useParallel = true;
fsArray = fsArray.process(useParallel);
fsArray_state = {fsArray.state}
</pre><pre class="codeoutput">Processing array: 100% [===========================================]

fsArray_state = 

    'processed'    'processed'    'processed'

</pre><p><h3>Plot a figure showing the output</h3></p><pre class="codeinput"><span class="comment">% Plot a figure showing the output</span>
hFig03 = fs03.plot();
set(hFig03, <span class="string">'Position'</span>, [50, 50, 800, 1000])
</pre><img vspace="5" hspace="5" src="pi_FrameScan_01.png" alt=""> <p><h3>Produce a GUI to optimise the parameters</h3></p><pre class="codeinput"><span class="comment">% Produce a GUI to optimise the parameters</span>
hFigOpt = fs03.opt_config();
</pre><img vspace="5" hspace="5" src="pi_FrameScan_02.png" alt=""> <p><h3>Output the data</h3></p><pre class="codeinput"><span class="comment">% Output the data.  This requires write access to the working directory</span>
fnCSV03 = fs03.output_data(<span class="string">'fs03'</span>, <span class="string">'overwrite'</span>, true);
</pre><pre class="codeinput"><span class="comment">% First, the diameter data</span>
fID03_diameter = fopen(fnCSV03{1}, <span class="string">'r'</span>);
fileContents03d = textscan(fID03_diameter, <span class="string">'%s'</span>);
fileContents03d{1}{1:5}
fclose(fID03_diameter);
</pre><pre class="codeoutput">
ans =

time,diameter,maskSTD,mask


ans =

0.083,138.032,FALSE,FALSE


ans =

0.248,136.281,FALSE,FALSE


ans =

0.413,135.157,FALSE,FALSE


ans =

0.578,136.262,FALSE,FALSE

</pre><pre class="codeinput"><span class="comment">% Then, the velocity data</span>
fID03_velocity = fopen(fnCSV03{2}, <span class="string">'r'</span>);
fileContents03v = textscan(fID03_velocity, <span class="string">'%s'</span>);
fileContents03v{1}{1:5}
fclose(fID03_velocity);
</pre><pre class="codeoutput">
ans =

time,velocity,flux,lineDensity,linearDensity,yPosition,theta,estSNR,maskSNR,maskSTD,mask


ans =

0.016,596.826,66.489,0.111,0.007,103,89.700,4.785,FALSE,TRUE,TRUE


ans =

0.020,34.338,199.468,5.809,0.368,116,84.800,4.848,FALSE,FALSE,FALSE


ans =

0.024,34.338,199.468,5.809,0.326,130,84.800,7.208,FALSE,FALSE,FALSE


ans =

0.028,36.452,166.223,4.560,0.324,143,85.100,9.288,FALSE,FALSE,FALSE

</pre><p class="footer"><br><a href="http://www.mathworks.com/products/matlab/">Published with MATLAB&reg; R2016a</a><br></p></div><!--
##### SOURCE BEGIN #####
%% FrameScan
% Analyse frame scan images of vessels

%% Usage
%   OBJ = FrameScan(NAME, RAWIMG, CONFIG, ISDS, COLS_V, ROWS_V, COLS_D)

%% Arguments
% * |NAME| is the name for this |FrameScan| object.
% * |RAWIMG| is the |RawImg| object that will be used to create the
% |FrameScan| object.
% * |CONFIG| contains the configuration parameters needed for the
% |calcVelocity| and |calcDiameter| object.
% * |ISDS| specifies whether the streaks to analyse are dark (i.e.
% negatively labelled) or bright (i.e. positively labelled).
% * |COLS_V| specifies the left and right columns that will form the edges
% of the |RawImg| data to use in the velocity calculation.
% * |ROWS_V| specifies the top and bottom rows that will form the edges of
% the |RawImg| data to use in the velocity calculation.
% * |COLS_D| specifies the left and right columns that will form the edges
% of the |RawImg| data to use in the diameter calculation.
        
%% Details
% |FrameScan| objects are used to analyse both the velocities and diameters
% from frame scan images of blood vessels.  Typically, the blood plasma
% will be labelled by a fluorescent marker, like a dextran conjugated
% fluorophore (e.g. FITC, as in the figure below), but the method also
% works with labelled red blood cells (RBCs).
%
% <<fs_example_rawImg.png>>

%% See Also
% * <matlab:doc('FrameScan') |FrameScan| class documentation>
% * <matlab:doc('ConfigFrameScan') |ConfigFrameScan| class documentation>
% * <matlab:doc('ConfigVelocityRadon') |ConfigVelocityRadon| class documentation>
% * <matlab:doc('ConfigVelocityLSPIV') |ConfigVelocityLSPIV| class documentation>
% * <matlab:doc('ConfigDiameterFWHM') |ConfigDiameterFWHM| class documentation>
% * <matlab:doc('CalcVelocityRadon') |CalcVelocityRadon| class documentation>
% * <matlab:doc('CalcVelocityLSPIV') |CalcVelocityLSPIV| class documentation>
% * <matlab:doc('CalcDiameterFWHM') |CalcDiameterFWHM| class documentation>
% * <matlab:doc('ImgGroup') |ImgGroup| class documentation>
% * <ig_ImgGroup.html |ImgGroup| quick start guide>

%% Examples
% The following examples require the sample images and other files, which
% can be downloaded manually, from the University of Zurich website
% (<http://www.pharma.uzh.ch/en/research/functionalimaging/CHIPS.html>), or
% automatically, by running the function |utils.download_example_imgs()|.
%
% <html><h3>Create a <tt>FrameScan</tt> object interactively</h3></html>
%
% The following example will illustrate the process of creating a
% |FrameScan| object interactively, starting with calling the constructor.
%
%   % Call the FrameScan constructor
%   fs01 = FrameScan()
%
% Since no RawImg has been specified, the first stage is to select the type
% of RawImg to create.  Press three and then enter to select the SCIM_Tif.  
%
%  REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH- What type of RawImg would you like to load? REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH-
%  
%    >> 1) BioFormats
%       2) RawImgDummy
%       3) SCIM_Tif
%  
%  Select a format: 3
%
% A warning may appear about the pixel aspect ratio, but this is not
% relevant for |FrameScan| images.
%
% Then, use the interactive dialogue box to select the raw image file
% |framescan_scim.tif|, which should be located in the subfolder
% tests>res, within the CHIPS root directory.
%
% <<fs_sel_rawImg.png>>
%
% Use the interactive dialogue box to select the dummy calibration 
% (|calibration_dummy.mat|):
%
% <<sel_cal.png>>
%
% The next stage is to define the 'meaning' of the image channels.  The
% first channel represents the blood plasma. Press one and then enter to
% complete the selection.
%
%  REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH- What is shown on channel 1? REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH-
%  
%    >> 0) <blank>
%       1) blood_plasma
%       2) blood_rbcs
%  
%  Answer: 1
%
% The next stage is to specify which velocity calculation algorithm should
% be used. In this case we will choose the Radon transform method.  Press
% two and then enter to complete the selection.
%
%  REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH- What type of velocity calculation would you like to use? REPLACE_WITH_DASH_DASHREPLACE_WITH_DASH_DASH-
%  
%    >> 1) CalcVelocityLSPIV
%       2) CalcVelocityRadon
%
%  Select a format: 2
%
% The next stage is to select the limits of the image to use for velocity
% calculations.  Selecting left and right limits can be useful to exclude
% the edges where there can be artefacts associated with the scan mirrors
% changing speed and/or direction.  Selecting top and bottom limits ensures
% that the velocity is only calculated inside the vessel.
%
% <<fs_sel_edges_lr_v.png>>
%
% <<fs_sel_edges_tb_v.png>>
%
% The final stage is to select the left and right limits of the image to
% use for diameter calculations.  This can be useful to exclude the edges
% where there can be artefacts associated with other vessels or fluorescent
% areas.
%
% <<fs_sel_edges_lr_d.png>>
%
% We have now created a |FrameScan| object interactively.
%
%  fs01 = 
% 
%    FrameScan with properties:
% 
%      calcDiameter: [1x1 CalcDiameterFWHM]
%     colsToUseDiam: [21 110]
%      rowsToUseVel: [27 94]
%          plotList: [1x1 struct]
%      calcVelocity: [1x1 CalcVelocityRadon]
%      colsToUseVel: [20 112]
%     isDarkStreaks: 1
%             state: 'unprocessed'
%              name: 'framescan_scim'
%            rawImg: [1x1 SCIM_Tif]
%      isDarkPlasma: 0
%
% The process is almost exactly the same to create an array of |FrameScan|
% objects; when the software prompts you to select one or more raw images,
% simply select multiple images by using either the shift or control key.

%%
%
% <html><h3>Prepare a <tt>RawImg</tt> for use in these examples</h3></html>
%

% Prepare a rawImg for use in these examples
fnRawImg = fullfile(utils.CHIPS_rootdir, 'tests', 'res', ...
    'framescan_scim.tif');
channels = struct('blood_plasma', 1);
fnCalibration = fullfile(utils.CHIPS_rootdir, 'tests', 'res', ...
    'calibration_dummy.mat');
calibration = CalibrationPixelSize.load(fnCalibration);
rawImg = SCIM_Tif(fnRawImg, channels, calibration);

%%
%
% <html><h3>Create a <tt>FrameScan</tt> object without any interaction</h3></html>
%

% Create a FrameScan object without any interaction
nameFS02 = 'test FS 02';
configFS = ConfigFrameScan(ConfigVelocityLSPIV(), ConfigDiameterFWHM);
isDarkStreaks = [];
colsToUseVel = [20 112];
rowsToUseVel = [27 94];
colsToUseDiam = [21 110];
fs02 = FrameScan(nameFS02, rawImg, configFS, isDarkStreaks, ...
    colsToUseVel, rowsToUseVel, colsToUseDiam)

%%
%
% <html><h3>Create a <tt>FrameScan</tt> object with a custom config</h3></html>
%

% Create a FrameScan object with a custom config
configCustom = ConfigFrameScan(...
    ConfigVelocityRadon('windowTime', 30, 'nOverlap', 6), ...
    ConfigDiameterFWHM('maxRate', 10, 'lev50', 0.6));
fs03 = FrameScan('test FS 03', rawImg, configCustom, ...
    isDarkStreaks, colsToUseVel, rowsToUseVel, colsToUseDiam);
confDiam = fs03.calcDiameter.config
confVel = fs03.calcVelocity.config

%%
%
% <html><h3>Create a <tt>FrameScan</tt> object array</h3></html>
%

% Create the RawImg array first 
rawImgArray(1:3) = copy(rawImg);
rawImgArray = copy(rawImgArray)
%%

% Then create the FrameScan object array
fsArray = FrameScan('test FS Array', rawImgArray, configCustom, ...
    isDarkStreaks, colsToUseVel, rowsToUseVel, colsToUseDiam)

%%
%
% <html><h3>Process a scalar <tt>FrameScan</tt> object</h3></html>
%

% Process a scalar FrameScan object
fs03 = fs03.process()

%%
%
% <html><h3>Process a <tt>FrameScan</tt> object array (in parallel)</h3></html>
%

% Process a FrameScan object array (in parallel).
% This code requires the Parallel Computing Toolbox to run in parallel
useParallel = true;
fsArray = fsArray.process(useParallel);
fsArray_state = {fsArray.state}

%%
%
% <html><h3>Plot a figure showing the output</h3></html>
%

% Plot a figure showing the output
hFig03 = fs03.plot();
set(hFig03, 'Position', [50, 50, 800, 1000])

%%
%
% <html><h3>Produce a GUI to optimise the parameters</h3></html>
%

% Produce a GUI to optimise the parameters
hFigOpt = fs03.opt_config();

%%
%
% <html><h3>Output the data</h3></html>
%

% Output the data.  This requires write access to the working directory
fnCSV03 = fs03.output_data('fs03', 'overwrite', true);
%%

% First, the diameter data
fID03_diameter = fopen(fnCSV03{1}, 'r');
fileContents03d = textscan(fID03_diameter, '%s');
fileContents03d{1}{1:5}
fclose(fID03_diameter);
%%

% Then, the velocity data
fID03_velocity = fopen(fnCSV03{2}, 'r');
fileContents03v = textscan(fID03_velocity, '%s');
fileContents03v{1}{1:5}
fclose(fID03_velocity);

##### SOURCE END #####
--></body></html>